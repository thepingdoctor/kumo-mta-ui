import{z as e,s,E as t,r as a,j as r,k as d,F as l,y as i,A as n,t as c,v as o,b as x,G as u,H as m}from"./react-vendor-CYm809Et.js";import{apiService as h}from"./api-BZ6vNX7b.js";import{a as p}from"./useToast-DgYTMLSM.js";import{h as g}from"./vendor-DC1Pnyyi.js";import{L as y}from"./LoadingSkeleton-DA_UOSRD.js";import{E as v,e as j,a as b}from"./exportUtils-CXa4SXtf.js";import"./chart-vendor-hJRC9QiP.js";import"./http-vendor-CHM7ATol.js";import"./authStore-D2_G-NGY.js";import"./utils-vendor-YtSAaKOK.js";const f="Failed to load queue data",N=e=>({id:e.id,message_id:e.email||`msg-${e.id}`,queue_name:e.priority,recipient:e.email,sender:e.name,domain:e.email.split("@")[1]||"unknown",status:_(e.status),queue_state:"active",priority:"high"===e.priority?8:"medium"===e.priority?5:2,size_bytes:0,num_attempts:0,max_attempts:20,created_at:e.createdAt}),_=e=>({pending:"ready",active:"in_delivery",resolved:"delivered",cancelled:"cancelled"}[e]||"ready");const w=({items:e,onStatusChange:s,isLoading:t})=>{if(t)return r.jsx("div",{className:"rounded-lg bg-white shadow overflow-hidden",children:r.jsxs("div",{className:"animate-pulse p-4",children:[r.jsx("div",{className:"h-4 bg-gray-200 rounded w-full mb-2"}),r.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"})]})});if(0===e.length)return r.jsxs("div",{className:"rounded-lg bg-white shadow p-8 text-center",children:[r.jsx(d,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),r.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No messages in queue"}),r.jsx("p",{className:"text-sm text-gray-500",children:"Queue is empty or all messages match your filters."})]});const a=e=>{const s={scheduled:"bg-purple-100 text-purple-800",ready:"bg-blue-100 text-blue-800",in_delivery:"bg-indigo-100 text-indigo-800",suspended:"bg-yellow-100 text-yellow-800",deferred:"bg-orange-100 text-orange-800",bounced:"bg-red-100 text-red-800",delivered:"bg-green-100 text-green-800",expired:"bg-gray-100 text-gray-800",cancelled:"bg-gray-100 text-gray-800"};return s[e]||s.ready},x=e=>{if(!e)return"N/A";try{return g(new Date(e),"MMM dd, HH:mm:ss")}catch{return"Invalid date"}},u=e=>{const s={hard:"bg-red-100 text-red-800",soft:"bg-orange-100 text-orange-800",block:"bg-yellow-100 text-yellow-800",complaint:"bg-purple-100 text-purple-800",unknown:"bg-gray-100 text-gray-800"};return e?s[e]||s.unknown:""};return r.jsx("div",{className:"overflow-hidden rounded-lg bg-white shadow",children:r.jsx("div",{className:"overflow-x-auto",children:r.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[r.jsx("thead",{className:"bg-gray-50",children:r.jsxs("tr",{children:[r.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Message ID"}),r.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Recipient Details"}),r.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Queue Info"}),r.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),r.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Delivery Attempts"}),r.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Timestamps"}),r.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),r.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:e.map(e=>r.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:r.jsxs("div",{className:"text-sm",children:[r.jsx("div",{className:"font-mono text-xs text-gray-600 mb-1",title:e.message_id,children:e.message_id.length>20?`${e.message_id.substring(0,20)}...`:e.message_id}),r.jsxs("div",{className:"text-xs text-gray-400",children:["Size: ",(e.size_bytes/1024).toFixed(1)," KB"]})]})}),r.jsx("td",{className:"px-6 py-4",children:r.jsxs("div",{className:"text-sm",children:[r.jsxs("div",{className:"flex items-center mb-1",children:[r.jsx(d,{className:"h-4 w-4 text-gray-400 mr-1","aria-hidden":"true"}),r.jsx("span",{className:"font-medium text-gray-900",children:e.recipient})]}),r.jsxs("div",{className:"flex items-center text-gray-500 mb-1",children:[r.jsx(l,{className:"h-3 w-3 text-gray-400 mr-1"}),r.jsx("span",{className:"text-xs",children:e.sender})]}),r.jsxs("div",{className:"flex items-center text-gray-500",children:[r.jsx(i,{className:"h-3 w-3 text-gray-400 mr-1"}),r.jsx("span",{className:"text-xs font-medium",children:e.domain})]})]})}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:r.jsxs("div",{className:"text-sm",children:[r.jsx("div",{className:"font-medium text-gray-900 mb-1",children:e.queue_name}),r.jsxs("div",{className:"text-xs text-gray-500",children:["Priority: ",e.priority,"/10"]}),e.pool_name&&r.jsxs("div",{className:"text-xs text-gray-500",children:["Pool: ",e.pool_name]})]})}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:r.jsxs("div",{children:[r.jsx("span",{className:`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${a(e.status)}`,children:e.status.replace("_"," ")}),e.bounce_classification&&r.jsx("div",{className:"mt-1",children:r.jsxs("span",{className:`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${u(e.bounce_classification)}`,children:[e.bounce_classification," bounce"]})}),e.smtp_response&&r.jsxs("div",{className:"mt-1 text-xs text-gray-500",title:e.smtp_response.message,children:["SMTP: ",e.smtp_response.code,e.smtp_response.enhanced_code&&` (${e.smtp_response.enhanced_code})`]})]})}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:r.jsxs("div",{className:"text-sm",children:[e.num_attempts>0?r.jsxs("div",{className:"flex items-center mb-1",children:[r.jsx(n,{className:"h-4 w-4 mr-1 "+(e.num_attempts>=.8*e.max_attempts?"text-red-500":"text-yellow-500")}),r.jsxs("span",{className:"font-medium "+(e.num_attempts>=.8*e.max_attempts?"text-red-600":"text-gray-900"),children:[e.num_attempts," / ",e.max_attempts]})]}):r.jsx("div",{className:"text-gray-500",children:"No attempts"}),e.last_attempt_at&&r.jsxs("div",{className:"text-xs text-gray-500",children:["Last: ",x(e.last_attempt_at)]}),e.next_attempt_at&&r.jsxs("div",{className:"text-xs text-blue-600",children:["Next: ",x(e.next_attempt_at)]}),e.last_bounce_reason&&r.jsxs("div",{className:"mt-1 flex items-start",children:[r.jsx(c,{className:"h-3 w-3 text-orange-500 mr-1 mt-0.5 flex-shrink-0"}),r.jsx("span",{className:"text-xs text-gray-600 line-clamp-2",title:e.last_bounce_reason,children:e.last_bounce_reason.length>50?`${e.last_bounce_reason.substring(0,50)}...`:e.last_bounce_reason})]})]})}),r.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[r.jsxs("div",{className:"flex items-center mb-1",children:[r.jsx(o,{className:"h-4 w-4 text-gray-400 mr-1","aria-hidden":"true"}),r.jsxs("div",{children:[r.jsx("div",{className:"text-xs font-medium text-gray-700",children:"Created"}),r.jsx("div",{className:"text-xs",children:x(e.created_at)})]})]}),e.scheduled_at&&r.jsxs("div",{className:"text-xs text-purple-600 mb-1",children:["Scheduled: ",x(e.scheduled_at)]}),e.delivered_at&&r.jsxs("div",{className:"text-xs text-green-600 mb-1",children:["Delivered: ",x(e.delivered_at)]}),e.expires_at&&r.jsxs("div",{className:"text-xs text-red-600",children:["Expires: ",x(e.expires_at)]})]}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:r.jsxs("select",{value:e.status,onChange:t=>s(e.id,t.target.value),className:"rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm","aria-label":`Change status for message ${e.message_id}`,children:[r.jsx("option",{value:"scheduled",children:"Scheduled"}),r.jsx("option",{value:"ready",children:"Ready"}),r.jsx("option",{value:"in_delivery",children:"In Delivery"}),r.jsx("option",{value:"suspended",children:"Suspended"}),r.jsx("option",{value:"deferred",children:"Deferred"}),r.jsx("option",{value:"bounced",children:"Bounced"}),r.jsx("option",{value:"delivered",children:"Delivered"}),r.jsx("option",{value:"expired",children:"Expired"}),r.jsx("option",{value:"cancelled",children:"Cancelled"})]})})]},e.id))})]})})})},S=()=>{const[d,l]=a.useState(""),[i,n]=a.useState(""),[c,o]=a.useState(""),[g,_]=a.useState(""),[S,q]=a.useState(""),k=p(),D={search_query:function(e,s=500){const[t,r]=a.useState(e);return a.useEffect(()=>{const t=setTimeout(()=>{r(e)},s);return()=>{clearTimeout(t)}},[e,s]),t}(d,300)||void 0,status:i||void 0,domain:c||void 0,bounce_type:S||void 0,limit:100,sort_by:"created_at",sort_order:"desc"},{data:F,isLoading:K,error:Q,refetch:C,updateStatus:R}=(a=>{const r=e();"status"in a&&("pending"===a.status||"active"===a.status||"resolved"===a.status||a.status);return{...s({queryKey:["queue",a],queryFn:async()=>{try{return(await h.queue.getItems(a)).data.map(N)}catch{throw new Error(f)}}}),updateStatus:t({mutationFn:({id:e,status:s})=>h.queue.updateStatus(e,s),onSuccess:()=>{r.invalidateQueries({queryKey:["queue"]})}}),addCustomer:t({mutationFn:e=>h.queue.addCustomer(e),onSuccess:()=>{r.invalidateQueries({queryKey:["queue"]})}}),suspendQueue:t({mutationFn:({domain:e,reason:s,duration:t})=>h.kumomta.suspendQueue(e,s,t),onSuccess:()=>{r.invalidateQueries({queryKey:["queue"]})}}),resumeQueue:t({mutationFn:({domain:e})=>h.kumomta.resumeQueue(e),onSuccess:()=>{r.invalidateQueries({queryKey:["queue"]})}}),suspendReadyQueue:t({mutationFn:({domain:e,reason:s})=>h.kumomta.suspendReadyQueue(e,s),onSuccess:()=>{r.invalidateQueries({queryKey:["queue"]})}}),rebindMessages:t({mutationFn:e=>h.kumomta.rebindMessages(e),onSuccess:()=>{r.invalidateQueries({queryKey:["queue"]})}}),bounceMessages:t({mutationFn:e=>h.kumomta.bounceMessages(e),onSuccess:()=>{r.invalidateQueries({queryKey:["queue"]})}})}})(D),M=F?(e=>{const s=e.length,t=e.filter(e=>"ready"===e.status||"scheduled"===e.status||"deferred"===e.status).length,a=e.filter(e=>"delivered"===e.status).length,r=e.filter(e=>"bounced"===e.status).length;return{total:s,queueDepth:t,delivered:a,bounced:r,inDelivery:e.filter(e=>"in_delivery"===e.status).length,suspended:e.filter(e=>"suspended"===e.status).length,deliveryRate:s>0?(a/s*100).toFixed(1):"0.0",bounceRate:s>0?(r/s*100).toFixed(1):"0.0"}})(F):null;return Q?r.jsxs("div",{className:"space-y-6",children:[r.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Email Queue Management"}),r.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg",children:[r.jsx("p",{className:"text-red-700",children:"Error loading queue data. Please try again."}),r.jsx("button",{onClick:()=>C(),className:"mt-2 text-sm text-red-600 hover:text-red-800 underline",children:"Retry"})]})]}):r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Email Queue Management"}),r.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Monitor and manage email messages in delivery queues"})]}),r.jsxs("div",{className:"flex space-x-3",children:[r.jsxs("button",{onClick:()=>C(),className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500","aria-label":"Refresh queue data",children:[r.jsx(x,{className:"h-4 w-4 mr-2"}),"Refresh"]}),r.jsx(v,{onExport:e=>{if(F&&0!==F.length)try{if("pdf"===e)j(F),k.success("Queue data exported to PDF successfully");else{const e=[{header:"Message ID",dataKey:"message_id"},{header:"Recipient",dataKey:"recipient"},{header:"Sender",dataKey:"sender"},{header:"Domain",dataKey:"domain"},{header:"Queue Name",dataKey:"queue_name"},{header:"Status",dataKey:"status"},{header:"Priority",dataKey:"priority"},{header:"Attempts",dataKey:"num_attempts"},{header:"Size (bytes)",dataKey:"size_bytes"},{header:"Campaign ID",dataKey:"campaign_id"},{header:"Bounce Type",dataKey:"bounce_classification"},{header:"Last Bounce",dataKey:"last_bounce_reason"},{header:"Created At",dataKey:"created_at"},{header:"Delivered At",dataKey:"delivered_at"}];b(F,`email-queue-export-${Date.now()}.csv`,e),k.success("Queue data exported to CSV successfully")}}catch(s){k.error("Failed to export data. Please try again.")}else k.warning("No data to export")},disabled:!F||0===F.length,formats:["pdf","csv"],label:"Export"})]})]}),M&&r.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[r.jsxs("div",{className:"grid grid-cols-2 gap-4 sm:grid-cols-4 lg:grid-cols-6",children:[r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-2xl font-bold text-gray-900",children:M.total}),r.jsx("div",{className:"text-sm text-gray-500",children:"Total Messages"})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-2xl font-bold text-orange-600",children:M.queueDepth}),r.jsx("div",{className:"text-sm text-gray-500",children:"Queue Depth"})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-2xl font-bold text-blue-600",children:M.inDelivery}),r.jsx("div",{className:"text-sm text-gray-500",children:"In Delivery"})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-2xl font-bold text-green-600",children:M.delivered}),r.jsx("div",{className:"text-sm text-gray-500",children:"Delivered"})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-2xl font-bold text-red-600",children:M.bounced}),r.jsx("div",{className:"text-sm text-gray-500",children:"Bounced"})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"text-2xl font-bold text-purple-600",children:M.suspended}),r.jsx("div",{className:"text-sm text-gray-500",children:"Suspended"})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-200",children:[r.jsxs("div",{className:"text-center",children:[r.jsxs("div",{className:"text-xl font-semibold text-green-600",children:[M.deliveryRate,"%"]}),r.jsx("div",{className:"text-sm text-gray-500",children:"Delivery Rate"})]}),r.jsxs("div",{className:"text-center",children:[r.jsxs("div",{className:"text-xl font-semibold text-red-600",children:[M.bounceRate,"%"]}),r.jsx("div",{className:"text-sm text-gray-500",children:"Bounce Rate"})]})]})]}),r.jsx("div",{className:"bg-white rounded-lg shadow p-4",children:r.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-5",children:[r.jsxs("div",{className:"relative lg:col-span-2",children:[r.jsx("label",{htmlFor:"search",className:"sr-only",children:"Search"}),r.jsx(u,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400","aria-hidden":"true"}),r.jsx("input",{id:"search",type:"text",placeholder:"Search recipient, sender, message ID...",value:d,onChange:e=>l(e.target.value),className:"pl-10 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"status-filter",className:"sr-only",children:"Filter by status"}),r.jsxs("div",{className:"relative",children:[r.jsx(m,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400","aria-hidden":"true"}),r.jsxs("select",{id:"status-filter",value:i,onChange:e=>n(e.target.value),className:"pl-10 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[r.jsx("option",{value:"",children:"All Statuses"}),r.jsx("option",{value:"scheduled",children:"Scheduled"}),r.jsx("option",{value:"ready",children:"Ready"}),r.jsx("option",{value:"in_delivery",children:"In Delivery"}),r.jsx("option",{value:"suspended",children:"Suspended"}),r.jsx("option",{value:"deferred",children:"Deferred"}),r.jsx("option",{value:"bounced",children:"Bounced"}),r.jsx("option",{value:"delivered",children:"Delivered"}),r.jsx("option",{value:"expired",children:"Expired"}),r.jsx("option",{value:"cancelled",children:"Cancelled"})]})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"domain-filter",className:"sr-only",children:"Filter by domain"}),r.jsx("input",{id:"domain-filter",type:"text",placeholder:"Filter by domain...",value:c,onChange:e=>o(e.target.value),className:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"bounce-filter",className:"sr-only",children:"Filter by bounce type"}),r.jsxs("select",{id:"bounce-filter",value:S,onChange:e=>q(e.target.value),className:"w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[r.jsx("option",{value:"",children:"All Bounce Types"}),r.jsx("option",{value:"hard",children:"Hard Bounce"}),r.jsx("option",{value:"soft",children:"Soft Bounce"}),r.jsx("option",{value:"block",children:"Blocked"}),r.jsx("option",{value:"complaint",children:"Complaint"}),r.jsx("option",{value:"unknown",children:"Unknown"})]})]})]})}),K?r.jsx(y,{type:"table"}):r.jsx(w,{items:F||[],onStatusChange:async(e,s)=>{try{await R.mutateAsync({id:e,status:s}),k.success(`Status updated to ${s}`)}catch{k.error("Failed to update status. Please try again.")}},isLoading:R.isPending})]})};export{S as default};
